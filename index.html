<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø­ÙØ¸Ø© Ø§Ù„Ù…Ø§Ø¬Ø¯ Ø§Ù„Ø°ÙƒÙŠØ© | Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯</title>
    <link href="https://script.google.com/macros/s/AKfycbwTVSx7TiXgD3FCF57UDmzR6kgYDVXGWm8Wbt7b-bXBvIDl14pUBULsWoqWusEWS7HC/exec">
    <style>
        :root { --p: #1a000a; --g: #f9d976; --s: #2ecc71; --w: #ffffff; }
        body { background: var(--p); color: var(--w); font-family: 'Cairo', sans-serif; margin: 0; display: flex; justify-content: center; min-height: 100vh; background-image: radial-gradient(circle at top, #3d0016, #1a000a); overflow-x: hidden; }
        .app-container { width: 100%; max-width: 450px; padding: 20px; box-sizing: border-box; }
        .glass { background: rgba(255,255,255,0.05); border: 1px solid rgba(249,217,118,0.2); border-radius: 20px; padding: 20px; backdrop-filter: blur(10px); margin-bottom: 20px; }
        .logo-circle { width: 80px; height: 80px; background: var(--g); border-radius: 50%; margin: 20px auto; display: flex; justify-content: center; align-items: center; font-size: 2rem; color: var(--p); box-shadow: 0 0 20px rgba(249,217,118,0.3); }
        input { width: 100%; padding: 15px; margin: 10px 0; border-radius: 12px; border: 1px solid rgba(249,217,118,0.3); background: rgba(0,0,0,0.3); color: #fff; text-align: center; box-sizing: border-box; font-size: 1rem; }
        .btn { width: 100%; padding: 15px; border-radius: 12px; border: none; font-weight: 700; cursor: pointer; transition: 0.3s; font-family: 'Cairo'; }
        .btn-g { background: var(--g); color: var(--p); }
        .btn-g:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-s { background: var(--s); color: #fff; }
        .hidden { display: none; }
        .nav { position: fixed; bottom: 0; width: 100%; max-width: 450px; background: rgba(26, 0, 10, 0.95); display: flex; border-top: 1px solid rgba(249,217,118,0.2); padding: 10px 0; z-index: 1000; }
        .nav-i { flex: 1; text-align: center; font-size: 0.75rem; color: #888; cursor: pointer; }
        .nav-i.active { color: var(--g); }
        .stk { font-size: 0.7rem; color: var(--s); display: block; margin-bottom: 5px; }
        .history-item { border-bottom: 1px solid rgba(255,255,255,0.1); padding: 12px 0; font-size: 0.85rem; }
        .history-code { color: var(--g); font-family: monospace; font-size: 1rem; display: block; margin-top: 4px; }
    </style>
</head>
<body>

<div class="app-container">
    <div id="v-login">
        <div class="logo-circle">M</div>
        <h2 style="text-align:center; color: var(--g); margin-bottom: 5px;">Ø´Ø¨ÙƒØ© Ø§Ù„Ù…Ø§Ø¬Ø¯ Ø§Ù„Ø°ÙƒÙŠØ©</h2>
        <p style="text-align:center; opacity:0.7; font-size:0.9rem; margin-bottom:20px;">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø­Ø§ÙØ¸ Ø§Ù„Ø±Ù‚Ù…ÙŠØ©</p>
        
        <div class="glass">
            <div style="background: rgba(46, 204, 113, 0.1); padding: 10px; border-radius: 12px; margin-bottom: 15px; text-align:center;">
                <span style="color: var(--s); font-size: 0.85rem;">ğŸ Ø±ØµÙŠØ¯ Ø§ÙØªØªØ§Ø­ÙŠ Ù„Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†: 0.00 Ø±ÙŠØ§Ù„</span>
            </div>
            <input type="number" id="phone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ø§Ù„Ù…Ø±ØªØ¨Ø· (777XXXXXX)">
            <button id="b-login" class="btn btn-g" onclick="login()">Ø¯Ø®ÙˆÙ„ Ø¢Ù…Ù† Ù„Ù„Ù…Ø­ÙØ¸Ø©</button>
        </div>
    </div>

    <div id="v-main" class="hidden">
        <div style="text-align:center; margin-bottom:25px; padding-top:20px;">
            <p style="opacity:0.6; margin:0; font-size:0.9rem;">Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ</p>
            <h1 id="bal" style="font-size:3.8rem; margin:0; color:var(--g); font-weight:700;">0</h1>
            <p style="color:var(--g); margin:0;">Ø±ÙŠØ§Ù„ ÙŠÙ…Ù†ÙŠ</p>
        </div>

        <div id="t-buy" class="tab">
            <h4 style="color:var(--g); margin-bottom:15px;">ğŸ›’ ÙƒØ±ÙˆØª Ø§Ù„Ø´Ø¨ÙƒØ© Ø§Ù„Ù…ØªÙˆÙØ±Ø©</h4>
            <div id="grid" style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
                </div>
        </div>

        <div id="t-top" class="tab hidden">
            <div class="glass">
                <h3 style="color:var(--s); margin-top:0;">Ø¥ÙŠØ¯Ø§Ø¹ Ø±ØµÙŠØ¯ (Ø§Ù„ÙƒØ±ÙŠÙ…ÙŠ)</h3>
                <p style="font-size:0.8rem; opacity:0.7;">Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¨Ù„Øº ÙˆØ±Ù‚Ù… Ø§Ù„Ù…Ø±Ø¬Ø¹ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ù„Ù„Ù…Ø³Ø¤ÙˆÙ„:</p>
                <input type="number" id="t-amt" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø±Ø§Ø¯ Ø´Ø­Ù†Ù‡">
                <input type="text" id="t-ref" placeholder="Ø±Ù‚Ù… Ù…Ø±Ø¬Ø¹ Ø§Ù„ÙƒØ±ÙŠÙ…ÙŠ Ø§Ù„Ù…ÙƒÙˆÙ† Ù…Ù† 9 Ø£Ø±Ù‚Ø§Ù…">
                <button id="b-top" class="btn btn-s" onclick="topup()">Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø´Ø­Ù†</button>
            </div>
        </div>

        <div id="t-his" class="tab hidden">
            <div class="glass">
                <h3 style="margin-top:0;">ğŸ“œ Ø³Ø¬Ù„ ÙƒØ±ÙˆØªÙŠ Ø§Ù„Ù…Ø´ØªØ±Ø§Ø©</h3>
                <div id="h-list">
                    <p style="text-align:center; opacity:0.5;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„...</p>
                </div>
            </div>
        </div>

        <div style="height:100px;"></div>
    </div>

    <div id="nb" class="nav hidden">
        <div class="nav-i active" onclick="tab('buy',this)">ğŸ›’ Ø§Ù„ÙƒØ±ÙˆØª</div>
        <div class="nav-i" onclick="tab('top',this)">â• Ø´Ø­Ù†</div>
        <div class="nav-i" onclick="tab('his',this)">ğŸ“œ Ø³Ø¬Ù„ÙŠ</div>
        <div class="nav-i" onclick="logout()" style="color:#ff6b6b;">ğŸšª Ø®Ø±ÙˆØ¬</div>
    </div>
</div>

<script>
    // Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø§Ù„Ø°ÙŠ Ù‚Ø¯Ù…ØªÙ‡ Ù…Ø¯Ù…Ø¬ Ù‡Ù†Ø§
    const API = 'https://script.google.com/macros/s/AKfycbyG8f1bJeYGOqPSgMh4yQdsk0IWQKyznpnkt-TZaH1J9Ap8ooATildcSsZg2WY5p_UQ/exec';

    async function login() {
        const phoneInput = document.getElementById('phone');
        const phone = phoneInput.value.trim();
        const btn = document.getElementById('b-login');

        if(phone.length < 9) return alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ù‡Ø§ØªÙ ØµØ­ÙŠØ­");
        
        btn.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...";
        btn.disabled = true;

        let dId = localStorage.getItem('MAJ_DID') || 'DID-' + Math.random().toString(36).substr(2, 9).toUpperCase();
        localStorage.setItem('MAJ_DID', dId);

        try {
            const response = await fetch(`${API}?action=getWallet&id=${phone}&deviceId=${dId}`);
            const data = await response.json();
            
            if(data.error) {
                alert(data.msg);
                btn.disabled = false;
                btn.innerText = "Ø¯Ø®ÙˆÙ„ Ø¢Ù…Ù† Ù„Ù„Ù…Ø­ÙØ¸Ø©";
            } else {
                localStorage.setItem('MAJ_PHONE', phone);
                showUI(data);
            }
        } catch(e) {
            alert("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±. ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª.");
            btn.disabled = false;
            btn.innerText = "Ø¯Ø®ÙˆÙ„ Ø¢Ù…Ù† Ù„Ù„Ù…Ø­ÙØ¸Ø©";
        }
    }

    function showUI(data) {
        document.getElementById('v-login').classList.add('hidden');
        document.getElementById('v-main').classList.remove('hidden');
        document.getElementById('nb').classList.remove('hidden');
        document.getElementById('bal').innerText = data.balance;
        
        // Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¬Ù„
        const hl = document.getElementById('h-list');
        if(data.history && data.history.length > 0) {
            hl.innerHTML = data.history.map(h => `
                <div class="history-item">
                    <span>${h.packageName}</span>
                    <span class="history-code">${h.code}</span>
                </div>
            `).join('');
        } else {
            hl.innerHTML = "<p style='text-align:center; opacity:0.4;'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª Ø´Ø±Ø§Ø¡ Ø³Ø§Ø¨Ù‚Ø©</p>";
        }
        loadStock();
    }

    async function loadStock() {
        const grid = document.getElementById('grid');
        const packs = [100, 200, 300, 500, 1000, 2000];
        
        try {
            const res = await fetch(`${API}?action=getStock`);
            const stock = await res.json();
            
            grid.innerHTML = packs.map(p => `
                <div class="glass" style="text-align:center; padding:15px; margin:0;">
                    <span class="stk" style="color: ${stock['Ø¨Ø§Ù‚Ø© '+p] > 0 ? '#2ecc71' : '#ff6b6b'}">
                        ${stock['Ø¨Ø§Ù‚Ø© '+p] > 0 ? 'Ù…ØªÙˆÙØ±: ' + stock['Ø¨Ø§Ù‚Ø© '+p] : 'Ù†ÙØ¯'}
                    </span>
                    <h2 style="margin:5px 0;">${p} <small style="font-size:0.6rem">Ø±ÙŠØ§Ù„</small></h2>
                    <button class="btn btn-g" style="padding:8px; font-size:0.9rem" onclick="buy('Ø¨Ø§Ù‚Ø© ${p}')">Ø´Ø±Ø§Ø¡</button>
                </div>
            `).join('');
        } catch(e) { grid.innerHTML = "ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†"; }
    }

    async function buy(packageName) {
        const phone = localStorage.getItem('MAJ_PHONE');
        const dId = localStorage.getItem('MAJ_DID');
        if(!confirm(`Ù‡Ù„ ØªØ±ØºØ¨ ÙÙŠ Ø´Ø±Ø§Ø¡ ${packageName}ØŸ`)) return;

        try {
            const res = await fetch(`${API}?action=buyFromWallet&walletId=${phone}&deviceId=${dId}&packageName=${packageName}&qty=1`);
            const result = await res.json();
            if(result.success) {
                alert("âœ… ØªÙ…Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­!\nØ§Ù„ÙƒÙˆØ¯: " + result.code);
                location.reload();
            } else {
                alert("âŒ " + result.msg);
            }
        } catch(e) { alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„"); }
    }

    async function topup() {
        const amt = document.getElementById('t-amt').value;
        const ref = document.getElementById('t-ref').value;
        const phone = localStorage.getItem('MAJ_PHONE');
        const dId = localStorage.getItem('MAJ_DID');
        const btn = document.getElementById('b-top');

        if(!amt || !ref) return alert("ÙŠØ±Ø¬Ù‰ Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
        
        btn.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...";
        btn.disabled = true;

        try {
            await fetch(`${API}?action=requestTopup&walletId=${phone}&amount=${amt}&ref=${ref}&deviceId=${dId}`);
            alert("âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø´Ø­Ù†. Ø³ÙŠØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø±Ø¬Ø¹ ÙˆØ¥Ø¶Ø§ÙØ© Ø§Ù„Ø±ØµÙŠØ¯ ÙÙˆØ±Ø§Ù‹.");
            location.reload();
        } catch(e) {
            alert("ÙØ´Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„");
            btn.disabled = false;
            btn.innerText = "Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø´Ø­Ù†";
        }
    }

    function tab(id, el) {
        document.querySelectorAll('.tab').forEach(t => t.classList.add('hidden'));
        document.querySelectorAll('.nav-i').forEach(n => n.classList.remove('active'));
        document.getElementById('t-'+id).classList.remove('hidden');
        el.classList.add('active');
    }

    function logout() {
        if(confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ")) {
            localStorage.removeItem('MAJ_PHONE');
            location.reload();
        }
    }

    // ÙØ­Øµ Ø§Ù„Ø¬Ù„Ø³Ø© Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø©
    window.onload = () => {
        if(localStorage.getItem('MAJ_PHONE')) login();
    };
</script>

</body>
</html>
