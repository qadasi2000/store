<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>شبكة الماجد برو - الاحترافية V25.0</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #1a000a;
            --gold: #f9d976;
            --gold-dark: #b89b4d;
            --green: #2ecc71;
            --white: #ffffff;
            --card-bg: rgba(255, 255, 255, 0.07);
        }

        body {
            background: var(--primary);
            color: var(--white);
            font-family: 'Cairo', sans-serif;
            margin: 0;
            padding-bottom: 50px;
            background-image: radial-gradient(circle at top, #3d0016, #1a000a);
            background-attachment: fixed;
            overflow-x: hidden;
        }

        .container { max-width: 480px; margin: auto; padding: 15px; }

        /* البطاقة العلوية للمحفظة */
        .wallet-card {
            background: linear-gradient(145deg, rgba(255,255,255,0.1), rgba(0,0,0,0.2));
            border: 1px solid rgba(249,217,118,0.3);
            border-radius: 25px;
            padding: 25px;
            text-align: center;
            box-shadow: 0 15px 35px rgba(0,0,0,0.4);
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
        }

        .balance-title { font-size: 0.9rem; color: var(--gold); opacity: 0.8; margin-bottom: 5px; }
        .balance-value { font-size: 3.2rem; font-weight: 700; color: var(--white); margin: 0; line-height: 1; }
        .balance-currency { font-size: 1.2rem; color: var(--gold); margin-right: 5px; }

        /* مدخلات النصوص */
        input {
            width: 100%;
            padding: 14px;
            margin: 10px 0;
            border-radius: 12px;
            border: 1px solid rgba(249,217,118,0.2);
            background: rgba(0,0,0,0.4);
            color: #fff;
            text-align: center;
            font-size: 1rem;
            outline: none;
            box-sizing: border-box;
        }
        input:focus { border-color: var(--gold); background: rgba(0,0,0,0.6); }

        /* الأزرار */
        .btn {
            width: 100%;
            padding: 14px;
            border-radius: 12px;
            border: none;
            font-weight: 700;
            cursor: pointer;
            transition: 0.3s;
            margin-top: 5px;
            font-size: 1rem;
        }
        .btn-gold { background: var(--gold); color: #1a000a; }
        .btn-gold:hover { background: var(--gold-dark); }
        .btn-green { background: var(--green); color: white; }

        /* شبكة البطاقات */
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .pkg-card {
            background: var(--card-bg);
            border: 1px solid rgba(255,255,255,0.05);
            border-radius: 20px;
            padding: 15px;
            text-align: center;
            transition: 0.3s;
        }
        .pkg-card:hover { transform: translateY(-5px); border-color: var(--gold); }
        .pkg-price { font-size: 1.5rem; color: var(--gold); font-weight: 700; margin: 5px 0; }
        .stock-status { font-size: 0.75rem; color: var(--green); margin-bottom: 10px; display: block; }

        /* التبويبات (Tabs) */
        .tabs { display: flex; gap: 10px; margin-bottom: 15px; }
        .tab-btn { flex: 1; padding: 10px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.1); background: transparent; color: #aaa; cursor: pointer; font-size: 0.85rem; }
        .tab-btn.active { background: var(--gold); color: #000; border-color: var(--gold); }

        /* إشعارات التوست */
        #toast { 
            visibility: hidden; position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); 
            background: #333; color: #fff; padding: 12px 25px; border-radius: 50px; z-index: 1000; font-size: 0.9rem;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        #toast.show { visibility: visible; animation: fadeIn 0.5s, fadeOut 0.5s 2.5s; }

        @keyframes fadeIn { from { bottom: 0; opacity: 0; } to { bottom: 30px; opacity: 1; } }
        @keyframes fadeOut { from { bottom: 30px; opacity: 1; } to { bottom: 0; opacity: 0; } }

        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9999; display: flex; justify-content: center; align-items: center; visibility: hidden; }
        .loading-overlay.active { visibility: visible; }
    </style>
</head>
<body>

    <div id="loading" class="loading-overlay"><div style="color:var(--gold)">جاري المعالجة...</div></div>
    <div id="toast"></div>

    <div class="container">
        <h2 style="color:var(--gold); text-align: center; margin-bottom: 30px;">⚡ شبكة الماجد الذكية</h2>

        <div id="loginView" class="wallet-card">
            <h3 style="margin-top:0">تسجيل الدخول</h3>
            <p style="font-size:0.85rem; opacity:0.7">أدخل رقم الهاتف المرتبط بمحفظتك</p>
            <input type="number" id="phoneInput" placeholder="777XXXXXX">
            <button class="btn btn-gold" onclick="handleLogin()">دخول الحساب</button>
        </div>

        <div id="mainView" style="display:none">
            <div class="wallet-card">
                <div class="balance-title">رصيدك المتوفر</div>
                <div class="balance-value"><span id="balanceAmt">0</span><span class="balance-currency">ريال</span></div>
                <div id="walletIdDisplay" style="margin-top:10px; font-size:0.8rem; opacity:0.5">محفظة: --</div>
            </div>

            <div class="tabs">
                <button id="buyTab" class="tab-btn active" onclick="switchTab('buy')">شراء كروت</button>
                <button id="transferTab" class="tab-btn" onclick="switchTab('transfer')">تحويل</button>
                <button id="topupTab" class="tab-btn" onclick="switchTab('topup')">شحن رصيد</button>
            </div>

            <div id="buySection" class="section">
                <div class="grid" id="packagesGrid">
                    </div>
            </div>

            <div id="transferSection" class="section" style="display:none">
                <div class="wallet-card" style="background: rgba(255,255,255,0.03);">
                    <h4 style="margin:0 0 15px 0">إرسال رصيد فوري</h4>
                    <input type="number" id="toPhone" placeholder="رقم المستلم">
                    <input type="number" id="amountToTransfer" placeholder="المبلغ">
                    <button class="btn btn-gold" onclick="handleTransfer()">تأكيد التحويل الآن</button>
                </div>
            </div>

            <div id="topupSection" class="section" style="display:none">
                <div class="wallet-card" style="background: rgba(255,255,255,0.03); border-color: var(--green);">
                    <h4 style="margin:0 0 15px 0; color:var(--green)">طلب شحن محفظة</h4>
                    <p style="font-size:0.8rem; margin-bottom:15px">أدخل المبلغ وسيقوم المسؤول بتأكيده فوراً</p>
                    <input type="number" id="topupAmount" placeholder="أدخل المبلغ المطلوب">
                    <button class="btn btn-green" onclick="handleTopupRequest()">إرسال طلب الشحن</button>
                </div>
            </div>

            <p onclick="logout()" style="text-align:center; font-size:0.8rem; color:red; cursor:pointer; margin-top:20px;">تسجيل الخروج</p>
        </div>
    </div>

    <script>
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxV3X1u3aeP5Cm2q85qAguqX1ypfh5bfEi2yd858X0KdJM9z9w8w277HjyqdEed3OGL/exec';
        
        // الحصول على هوية الجهاز الثابتة
        function getDeviceId() {
            let id = localStorage.getItem('MAJED_DEVICE_ID');
            if(!id) {
                id = 'DEV-' + Math.random().toString(36).substr(2, 9).toUpperCase();
                localStorage.setItem('MAJED_DEVICE_ID', id);
            }
            return id;
        }

        // تسجيل الدخول
        async function handleLogin() {
            const phone = document.getElementById('phoneInput').value.trim();
            if(phone.length < 9) return showToast("⚠️ يرجى إدخال رقم صحيح");

            toggleLoading(true);
            try {
                const res = await fetch(`${SCRIPT_URL}?action=getWallet&id=${phone}&deviceId=${getDeviceId()}`);
                const data = await res.json();
                
                if(data.error) {
                    alert("❌ خطأ: هذا الرقم مسجل على جهاز آخر!");
                } else {
                    localStorage.setItem('MAJED_WALLET_ID', phone);
                    initMainUI(data);
                }
            } catch(e) { showToast("❌ فشل الاتصال بالسيرفر"); }
            toggleLoading(false);
        }

        // تهيئة الواجهة الرئيسية
        function initMainUI(data) {
            document.getElementById('loginView').style.display = 'none';
            document.getElementById('mainView').style.display = 'block';
            document.getElementById('balanceAmt').innerText = data.balance;
            document.getElementById('walletIdDisplay').innerText = "محفظة رقم: " + localStorage.getItem('MAJED_WALLET_ID');
            
            loadPackages();
        }

        // تحميل الباقات
        async function loadPackages() {
            const grid = document.getElementById('packagesGrid');
            const packs = [100, 200, 300, 500, 1000, 2000, 3000, 5000, 10000];
            
            grid.innerHTML = packs.map(p => `
                <div class="pkg-card">
                    <span class="stock-status" id="stock-${p}">فحص...</span>
                    <div class="pkg-price">${p} <small style="font-size:0.7rem">ريال</small></div>
                    <button class="btn btn-gold" style="padding:8px; font-size:0.8rem" onclick="buyTicket('باقة ${p}', ${p})">شراء</button>
                </div>
            `).join('');

            // تحديث المخزون
            try {
                const res = await fetch(`${SCRIPT_URL}?action=getStock`);
                const stocks = await res.json();
                packs.forEach(p => {
                    const el = document.getElementById(`stock-${p}`);
                    const count = stocks[`باقة ${p}`] || 0;
                    el.innerText = count > 0 ? `متوفر: ${count}` : "نفذ";
                    el.style.color = count > 0 ? "#2ecc71" : "#e74c3c";
                });
            } catch(e) {}
        }

        // شراء كرت
        async function buyTicket(name, price) {
            if(!confirm(`هل تريد شراء كرت ${name} بـ ${price} ريال؟`)) return;
            
            toggleLoading(true);
            const walId = localStorage.getItem('MAJED_WALLET_ID');
            try {
                const res = await fetch(`${SCRIPT_URL}?action=buyFromWallet&walletId=${walId}&deviceId=${getDeviceId()}&packageName=${name}&qty=1`);
                const data = await res.json();
                
                if(data.success) {
                    alert(`✅ مبروك! تم الشراء بنجاح.\nكود الكرت:\n${data.code}`);
                    location.reload();
                } else {
                    alert("❌ فشل الشراء: " + data.msg);
                }
            } catch(e) { alert("❌ حدث خطأ أثناء الاتصال"); }
            toggleLoading(false);
        }

        // تحويل رصيد
        async function handleTransfer() {
            const to = document.getElementById('toPhone').value.trim();
            const amt = document.getElementById('amountToTransfer').value;
            const from = localStorage.getItem('MAJED_WALLET_ID');

            if(!to || !amt) return showToast("⚠️ أكمل البيانات");
            if(!confirm(`هل أنت متأكد من تحويل ${amt} ريال إلى ${to}؟`)) return;

            toggleLoading(true);
            try {
                const res = await fetch(`${SCRIPT_URL}?action=transfer&from=${from}&to=${to}&amount=${amt}&deviceId=${getDeviceId()}`);
                const data = await res.json();
                if(data.success) {
                    alert("✅ تم التحويل بنجاح");
                    location.reload();
                } else {
                    alert("❌ فشل التحويل: " + data.msg);
                }
            } catch(e) {}
            toggleLoading(false);
        }

        // طلب شحن رصيد
        async function handleTopupRequest() {
            const amt = document.getElementById('topupAmount').value;
            const walId = localStorage.getItem('MAJED_WALLET_ID');
            if(!amt) return showToast("⚠️ أدخل المبلغ أولاً");

            toggleLoading(true);
            try {
                // نرسل الطلب وننتظر ثواني (بسبب طبيعة No-Cors في Apps Script لطلبات GET السريعة)
                fetch(`${SCRIPT_URL}?action=requestTopup&walletId=${walId}&amount=${amt}&deviceId=${getDeviceId()}`, {mode: 'no-cors'});
                
                setTimeout(() => {
                    alert("✅ تم إرسال طلبك للمسؤول.\nسيتم إضافة الرصيد بعد التأكد من العملية.");
                    document.getElementById('topupAmount').value = "";
                    toggleLoading(false);
                }, 1500);
            } catch(e) { toggleLoading(false); }
        }

        // التنقل بين التبويبات
        function switchTab(tab) {
            document.querySelectorAll('.section').forEach(s => s.style.display = 'none');
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            
            document.getElementById(tab + 'Section').style.display = 'block';
            document.getElementById(tab + 'Tab').classList.add('active');
        }

        function toggleLoading(show) { document.getElementById('loading').classList.toggle('active', show); }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        }

        function logout() {
            localStorage.removeItem('MAJED_WALLET_ID');
            location.reload();
        }

        // فحص تسجيل دخول سابق
        window.onload = () => {
            const savedWal = localStorage.getItem('MAJED_WALLET_ID');
            if(savedWal) {
                document.getElementById('phoneInput').value = savedWal;
                handleLogin();
            }
        };
    </script>
</body>
</html>
